<!-- start product-color-carousel.liquid (SECTION) - Carrossel de variedades de cores -->
{{ 'section-product-color-carousel.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign section_title = section.settings.section_title
  assign section_subtitle = section.settings.section_subtitle
  assign cta_label = section.settings.cta_label
  assign cta_url = section.settings.cta_url
  assign transition_duration = section.settings.transition_duration
  assign enable_autoplay = section.settings.enable_autoplay
  assign autoplay_speed = section.settings.autoplay_speed
  assign enable_animations = section.settings.enable_animations
  assign bg_style = section.settings.background_style
  assign bg_color = section.settings.background_color
  assign color_blocks = section.blocks | where: 'type', 'color_slide'
  assign default_images = 'logitech-white.png,logitech-black.png,logitech-red.png' | split: ','
  assign default_labels = 'Logitech White,Logitech Black,Logitech Red' | split: ','
  assign slide_count = color_blocks.size
  if slide_count == 0
    assign slide_count = 3
  endif
-%}

<section
  id="shopify-section-{{ section.id }}"
  class="pcc {{ section.settings.custom_class }}"
  aria-label="{{ section_title | default: 'Cores do produto' | escape }}"
  style="
    --pcc-bg: {{ bg_color }};
    --pcc-transition-duration: {{ transition_duration }}ms;
    --pcc-heading-size: {{ section.settings.heading_size }}px;
    --pcc-caption-size: {{ section.settings.caption_size }}px;
    --pcc-cta-bg: {{ section.settings.cta_bg }};
    --pcc-cta-text: {{ section.settings.cta_text }};
    --pcc-cta-border: {{ section.settings.cta_border }};
  "
  data-section-id="{{ section.id }}"
  data-enable-autoplay="{{ enable_autoplay }}"
  data-autoplay-speed="{{ autoplay_speed }}"
  data-enable-animations="{{ enable_animations }}"
  data-background-style="{{ bg_style }}"
>
  <div class="pcc__bg-effects" aria-hidden="true"></div>

  <div class="pcc__inner">
    {%- if section_title != blank or section_subtitle != blank -%}
      <header class="pcc__header">
        {%- if section_title != blank -%}
          <h2 class="pcc__title">{{ section_title }}</h2>
        {%- endif -%}
        {%- if section_subtitle != blank -%}
          <p class="pcc__subtitle">{{ section_subtitle }}</p>
        {%- endif -%}
      </header>
    {%- endif -%}

    <div class="pcc__carousel" data-pcc-carousel>
      <div class="pcc__viewport">
        <div class="pcc__track" role="list">
          {%- if color_blocks.size > 0 -%}
            {%- for block in color_blocks -%}
              {%- liquid
                assign slide_image = block.settings.image
                assign slide_asset = block.settings.asset_filename
                assign slide_label = block.settings.label
                assign slide_url = block.settings.link
                assign img_src = ''
                assign img_alt = slide_label | default: 'Produto' | escape
                if slide_image != blank
                  assign img_src = slide_image | image_url: width: 800
                elsif slide_asset != blank
                  assign img_src = slide_asset | asset_url
                else
                  assign idx = forloop.index0 | modulo: 3
                  assign img_src = default_images[idx] | asset_url
                  assign slide_label = slide_label | default: default_labels[idx]
                endif
              -%}
              <div
                class="pcc__slide {% if forloop.index0 == 0 %}pcc__slide--center{% endif %}"
                role="listitem"
                data-slide-index="{{ forloop.index0 }}"
                {{ block.shopify_attributes }}
              >
                <div class="pcc__slide-inner">
                  {%- if slide_url != blank -%}
                    <a href="{{ slide_url }}" class="pcc__slide-link" aria-label="{{ slide_label | escape }}">
                  {%- endif -%}
                  <div class="pcc__slide-img-wrap">
                    {%- if img_src != blank -%}
                      <img
                        src="{{ img_src }}"
                        alt="{{ img_alt }}"
                        width="600"
                        height="400"
                        loading="{% if forloop.index0 == 0 %}eager{% else %}lazy{% endif %}"
                        class="pcc__slide-img"
                      >
                    {%- endif -%}
                  </div>
                  {%- if slide_url != blank -%}
                    </a>
                  {%- endif -%}
                  {%- if slide_label != blank -%}
                    <p class="pcc__slide-caption">{{ slide_label }}</p>
                  {%- endif -%}
                </div>
              </div>
            {%- endfor -%}
          {%- else -%}
            {%- for i in (1..3) -%}
              {%- assign idx = forloop.index0 -%}
              {%- assign img_src = default_images[idx] | asset_url -%}
              {%- assign slide_label = default_labels[idx] -%}
              <div
                class="pcc__slide {% if idx == 0 %}pcc__slide--center{% endif %}"
                role="listitem"
                data-slide-index="{{ idx }}"
              >
                <div class="pcc__slide-inner">
                  <div class="pcc__slide-img-wrap">
                    <img
                      src="{{ img_src }}"
                      alt="{{ slide_label | escape }}"
                      width="600"
                      height="400"
                      loading="{% if idx == 0 %}eager{% else %}lazy{% endif %}"
                      class="pcc__slide-img"
                    >
                  </div>
                  <p class="pcc__slide-caption">{{ slide_label }}</p>
                </div>
              </div>
            {%- endfor -%}
          {%- endif -%}
        </div>
      </div>

      {%- if slide_count > 1 -%}
        <button
          type="button"
          class="pcc__nav pcc__nav--prev"
          aria-label="Cor anterior"
          data-pcc-prev
        >
          <span aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg></span>
        </button>
        <button
          type="button"
          class="pcc__nav pcc__nav--next"
          aria-label="Próxima cor"
          data-pcc-next
        >
          <span aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg></span>
        </button>

        <div class="pcc__dots" role="tablist" aria-label="Selecionar cor">
          {%- for i in (1..slide_count) -%}
            <button
              type="button"
              class="pcc__dot {% if forloop.index0 == 0 %}pcc__dot--active{% endif %}"
              role="tab"
              aria-selected="{% if forloop.index0 == 0 %}true{% else %}false{% endif %}"
              aria-label="Cor {{ forloop.index }}"
              data-pcc-dot="{{ forloop.index0 }}"
            ></button>
          {%- endfor -%}
        </div>
      {%- endif -%}
    </div>

    {%- if cta_label != blank -%}
      <div class="pcc__cta-wrap">
        <a href="{{ cta_url | default: '#' }}" class="pcc__cta">{{ cta_label }}</a>
      </div>
    {%- endif -%}
  </div>
</section>

<script>
  (function() {
    var section = document.querySelector('#shopify-section-{{ section.id }}');
    if (!section) return;
    var carousel = section.querySelector('[data-pcc-carousel]');
    var track = section.querySelector('.pcc__track');
    var slides = section.querySelectorAll('.pcc__slide');
    var prevBtn = section.querySelector('[data-pcc-prev]');
    var nextBtn = section.querySelector('[data-pcc-next]');
    var dots = section.querySelectorAll('[data-pcc-dot]');
    var total = slides.length;
    if (total < 2) return;

    var current = 0;
    var autoplayTimer = null;
    var enableAutoplay = section.dataset.enableAutoplay === 'true';
    var autoplaySpeed = parseInt(section.dataset.autoplaySpeed, 10) || 5000;

    function getPosition(slideIndex) {
      return (slideIndex - current + total) % total;
    }

    function updateCarousel() {
      slides.forEach(function(slide, i) {
        var pos = getPosition(i);
        slide.classList.remove('pcc__slide--left', 'pcc__slide--center', 'pcc__slide--right');
        slide.style.order = String(pos + 1);
        if (pos === 0) slide.classList.add('pcc__slide--left');
        else if (pos === 1) slide.classList.add('pcc__slide--center');
        else slide.classList.add('pcc__slide--right');
      });
      dots.forEach(function(dot, i) {
        dot.classList.toggle('pcc__dot--active', i === current);
        dot.setAttribute('aria-selected', i === current ? 'true' : 'false');
      });
    }

    function goTo(index) {
      current = (index + total) % total;
      updateCarousel();
      resetAutoplay();
    }

    function next() { goTo(current + 1); }
    function prev() { goTo(current - 1); }

    function resetAutoplay() {
      if (!enableAutoplay) return;
      clearTimeout(autoplayTimer);
      autoplayTimer = setTimeout(next, autoplaySpeed);
    }

    if (prevBtn) prevBtn.addEventListener('click', function() { prev(); });
    if (nextBtn) nextBtn.addEventListener('click', function() { next(); });
    dots.forEach(function(dot, i) {
      dot.addEventListener('click', function() { goTo(i); });
      dot.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); goTo(i); }
      });
    });

    var touchStartX = 0, touchEndX = 0;
    carousel.addEventListener('touchstart', function(e) {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });
    carousel.addEventListener('touchend', function(e) {
      touchEndX = e.changedTouches[0].screenX;
      var diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) { if (diff > 0) next(); else prev(); }
    }, { passive: true });

    if (enableAutoplay) resetAutoplay();
    updateCarousel();
  })();
</script>

{% schema %}
{
  "name": "Carrossel de Cores",
  "tag": "section",
  "class": "shopify-section--product-color-carousel",
  "settings": [
    {
      "type": "text",
      "id": "custom_class",
      "label": "Classe CSS customizada"
    },
    {
      "type": "header",
      "content": "Cabeçalho"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Título da seção",
      "default": "Escolha sua cor"
    },
    {
      "type": "text",
      "id": "section_subtitle",
      "label": "Subtítulo",
      "default": "Três variedades para combinar com seu espaço."
    },
    {
      "type": "header",
      "content": "Layout e fundo"
    },
    {
      "type": "select",
      "id": "background_style",
      "label": "Estilo do fundo",
      "options": [
        { "value": "solid", "label": "Cor sólida" },
        { "value": "gradient", "label": "Gradiente sutil" },
        { "value": "geometric", "label": "Formas geométricas" }
      ],
      "default": "gradient"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Cor de fundo",
      "default": "#f8f8f8"
    },
    {
      "type": "header",
      "content": "Tipografia"
    },
    {
      "type": "range",
      "id": "heading_size",
      "label": "Tamanho do título",
      "min": 18,
      "max": 42,
      "step": 2,
      "unit": "px",
      "default": 28
    },
    {
      "type": "range",
      "id": "caption_size",
      "label": "Tamanho da legenda (cor)",
      "min": 12,
      "max": 22,
      "step": 1,
      "unit": "px",
      "default": 14
    },
    {
      "type": "header",
      "content": "Carrossel"
    },
    {
      "type": "range",
      "id": "transition_duration",
      "label": "Duração da transição",
      "min": 200,
      "max": 800,
      "step": 50,
      "unit": "ms",
      "default": 400
    },
    {
      "type": "checkbox",
      "id": "enable_animations",
      "label": "Ativar animações suaves",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_autoplay",
      "label": "Ativar autoplay",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Velocidade do autoplay",
      "min": 3000,
      "max": 10000,
      "step": 500,
      "unit": "ms",
      "default": 5000
    },
    {
      "type": "header",
      "content": "Call to Action"
    },
    {
      "type": "text",
      "id": "cta_label",
      "label": "Texto do botão",
      "default": "Explore Mais"
    },
    {
      "type": "url",
      "id": "cta_url",
      "label": "URL do botão"
    },
    {
      "type": "color",
      "id": "cta_bg",
      "label": "Fundo do botão",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "cta_text",
      "label": "Texto do botão",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "cta_border",
      "label": "Borda do botão",
      "default": "#333333"
    }
  ],
  "blocks": [
    {
      "type": "color_slide",
      "name": "Cor do produto",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Imagem (sobrescreve arquivo abaixo)"
        },
        {
          "type": "text",
          "id": "asset_filename",
          "label": "Nome do arquivo no tema (ex: logitech-white.png)",
          "info": "Usado se nenhuma imagem for escolhida acima."
        },
        {
          "type": "text",
          "id": "label",
          "label": "Legenda (ex: Logitech White)",
          "default": "Logitech White"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link (página do produto ou coleção)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Carrossel de Cores",
      "blocks": [
        { "type": "color_slide", "settings": { "asset_filename": "logitech-white.png", "label": "Logitech White" } },
        { "type": "color_slide", "settings": { "asset_filename": "logitech-black.png", "label": "Logitech Black" } },
        { "type": "color_slide", "settings": { "asset_filename": "logitech-red.png", "label": "Logitech Red" } }
      ]
    }
  ]
}
{% endschema %}
