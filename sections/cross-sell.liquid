{%- capture cross_sell_css -%}
    {%- render 'style-cross-sell' -%}
{%- endcapture -%}

{%- capture  cross_sell_content -%}
  {{- cross_sell_css | replace: 'data-vasta', 'class="critical2"' -}}
  {{- cross_sell_css | replace: 'data-vasta', 'type="lazyload2"' -}}
  {% assign cross_sell_collection = section.settings.cross_sell_select_collection %}
  {%- assign enable_lazy = true -%}
  {%- assign temp_product = cross_sell_collection.products -%}
  {%- assign show_price = section.settings.show_price -%}
  {%- assign image_width = 560 -%}
  {%- assign width_mobile = 200 -%}
  {%- assign width_desk = 560 -%}
  {%- assign width_small = 300 -%}

  {%- assign qtd_desktop = section.settings.products_per_rows_desktop-%}
    
  <div class="cross-sell__wrapper {% if template contains "product" %} cross-sell__product__wrapper {% endif %}">
      {% if section.settings.enable_cross_sell_title %}
        {% if section.settings.cross_sell_title != blank %}
          <h2 class="cross-sell__title">{{ section.settings.cross_sell_title }}</h2>
        {% else %}
          <h2 class="cross-sell__title">{{ cross_sell_collection.title }}</h2> 
        {% endif %}
      {% endif %}
      {% if section.settings.cross_sell_select_collection != blank %}
        <div class="cross-sell__product-grid">
          {% assign = i = 0 %}

          {%- assign cart_items_ids = '' -%}

          {%- for item in cart.items -%}
            {%- assign cart_items_ids = cart_items_ids | append: ',' | append: item.product_id -%}
          {%- endfor -%}

            {% for temp_product in cross_sell_collection.products %}
              {%- unless cart_items_ids contains temp_product.id or temp_product.available == false -%}
                <div class="cross-sell__product-card">
                    {%- render 'product-card',
                        prod: temp_product,
                        width_mobile: width_mobile,
                        width_desk: width_desk,
                        max_width: image_width,
                        show_price: show_price 
                    -%}
                    <form action="/cart/add" id="cross-sell_form" class="cross-sell__product-form" >
                        {%- assign variants_size = temp_product.variants | size -%}
                        {%- if variants_size == 1 -%}
                            <input type="hidden" name="id" value="{{ temp_product.selected_or_first_available_variant.id }}"/>
                        {%- else -%}
                            <select name="id" class="cross-sell__product-select">
                                <option value="" data-image="{{ temp_product.selected_or_first_available_variant.image | img_url: '200x' }}" disabled>Choose Variant:</option>
                        
                                {% for variant in temp_product.variants %}
                                    <option value="{{ variant.id }}" data-image="{{ variant.image | img_url: '200x' }}"{% if cart_items contains variant.id %} disabled="disabled"{% endif %}>{{ variant.title }}</option>
                                {% endfor %}
                            </select>
                        {% endif %}
                            
                        <input type="hidden" name="quantity" value="1"/>
                        <button type="submit" class="cross-sell__product-button cart-icon btn btn-add-tocart">
                            <span class="cross-sell__product-button-text">Add To Cart</span>
                        </button>
                    </form>
                </div>
                {%- assign i = i | plus: 1 -%}
                {%- if i == 4 -%}
                  {%- break -%}
                {%- endif -%}
              {%- endunless -%}
            {% endfor %}
        </div>

      </div>
  {% endif %}

  <script type="layload2">
    setTimeout(function() {
      const methods = {
        cart: {
          /**
              * Get all cart items.
              */
          getCart() {
            return fetch('/cart.js', {
              cache: 'default'
            }).then(function(res) {
              return res.json();
            });
          },
          /**
              * Add some item into cart.
              *
              * @param {Object} data JSON object with data for to insert in cart.
              */
          addItem(data) {
            return fetch('/cart/add.js', {
              method: 'POST',
              body: data
            }).then(function(res) {
              return res.json();
            });
          }
        }
      }
      $('.cross-sell__product-form').submit(function (e) {
          e.preventDefault();
          const form = this;
          const data = new FormData(this);
      
          methods.cart.addItem(data).then(async function(item) {
            try {
              const cart = await methods.cart.getCart();
              const btn = form.querySelector('button');
              btn.disabled = 'disabled';
              location.reload();
            } catch (e) {
              console.error('[CART ERROR]', e);
            }
          }).catch(function(e) {
            console.error('[ADD ITEM ERROR]', e);
          });
        });
      
      });
  </script>
{%- endcapture -%}
{{- cross_sell_content | strip_newlines | replace: '    ' , ' ' | replace: '   ' , ' ' | replace: '  ' , ' ' -}} 
{% schema %}
{
  "name": "Cross Sell",
  "class": "cross-sell",
  "settings": [
    {
      "type": "header",
      "content": "GENERAL"
    },
    {
      "type": "checkbox",
      "id": "enable_cross_sell_title",
      "label": "Enable Title"
    },
    {
      "type": "text",
      "id": "cross_sell_title",
      "label": "Title"
    },
    {
      "type": "range",
      "id": "title-font-size",
      "min": 10,
      "max": 30,
      "step": 1,
      "label": "Title Font Size",
      "default": 16
    },
    {
      "type": "collection",
      "id": "cross_sell_select_collection",
      "label": "Collection"
    },
    {
        "type": "checkbox",
        "id":"show_price",
        "label":"Show Price"
    },
    {
      "type": "header",
      "content": "COLOR"
    },
    {
      "type": "color",
      "id":"title-color",
      "label":"Section Title Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id":"border-color",
      "label":"Border Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id":"product-title-color",
      "label":"Product Title Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id":"swatch-color",
      "label":"Swatch Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id":"price-color",
      "label":"Price Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id":"compare-price",
      "label":"Compare Price Color",
      "default": "#000000"
    }
  ],
  "presets": [
    {
      "name": "Cross Sell",
      "category": "Cross Sell"
    }
  ]
}
{% endschema %}
